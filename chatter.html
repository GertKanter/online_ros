<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8"/>
  <link rel="stylesheet" type="text/css" href="styles.css" />
  <title>ROS, By working example</title>
  <meta name="description" content="This page has working ROS examples that you can edit, compile and run online." />
  <meta name="keywords" content="ROS, code, compile, example, tutorial" />
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
</head>


  <body>

  <div class="navbar">
    <a href="index.html">ROS, by WORKING example</a>
    <a href="contribute.html">Contribute</a>
    <a href="about.html">About</a>
  </div>

<div style="float: left; width: 50%" class="main">

  <h1>{{example_title}}</h1>

  <div class="tab">
    <button class="tablinks" onclick="openFile(event, 'package.xml')">package.xml</button>
    <button class="tablinks" onclick="openFile(event, 'CMakeLists.txt')">CMakeLists.txt</button>
    <button class="tablinks" onclick="openFile(event, 'chatter.cpp')" id="defaultOpen">chatter.cpp</button>
  </div>

  <div id="package.xml" class="tabcontent">
    <textarea id="package_xml">{{package_xml}}</textarea>
  </div>

  <div id="CMakeLists.txt" class="tabcontent">
    <textarea id="CMakeLists.txt">{{cmakelists_txt}}</textarea>
  </div>

  <div id="chatter.cpp" class="tabcontent">
    <pre id="editor"></pre>
  </div>
    <input type="button" value="Compile" id="compile">
</div>

<div style="float: right; width: 50%" class="feedback">
   <textarea id="show_compile" readonly="readonly"></textarea>
   <textarea id="show_topic" readonly="readonly"></textarea>

</div>


<script type='text/javascript'>

// ROS code
var ros = new ROSLIB.Ros();
var roslib_connected = false;
 function try_ros_connection() {
   if (roslib_connected == false)
   {
     ros.connect('ws://localhost:9090');
   }
 }

 var interval_active = true;
 var interval = setInterval(try_ros_connection, 2000);


 ros.on('connection', function() {
   roslib_connected = true;
   console.log('Connected to websocket server.');
   interval_active = false;
   clearInterval(interval);
   var listener = new ROSLIB.Topic({
     ros : ros,
     name : '/chatter',
     messageType : 'std_msgs/String'
   });

   listener.subscribe(function(message) {
     console.log('Received message on ' + listener.name + ': ' + message.data);
     document.getElementById("show_topic").value += message.data + '\r';
     document.getElementById("show_topic").scrollTop = document.getElementById("show_topic").scrollHeight

     //listener.unsubscribe();
   });
 });

 ros.on('error', function(error) {
   console.log('Error connecting to websocket server: ', error);
 });

 ros.on('close', function() {
   console.log('Connection to websocket server closed.');
   roslib_connected = false;
   if (!interval_active)
   {
      interval_active = true;
      interval = setInterval(try_ros_connection, 1000);
   }
 });


$(document).ready(function(){
      var socket = io();
      socket.on('compile_output',function(msg){
      //  $("#show_compile").append(msg + '<br />');
      document.getElementById("show_compile").value += msg;
      document.getElementById("show_compile").scrollTop = document.getElementById("show_compile").scrollHeight
      });
});

var files = {};
   var editor = ace.edit("editor");
$.get("/get_files", function (data) {
   files = JSON.parse(data);

   editor.setTheme("ace/theme/chrome");
   editor.getSession().setMode("ace/mode/c_cpp");
   editor.setValue(files['chatter.cpp'], -1);
});




$('#compile').on('click', function() {
  document.getElementById("show_compile").value = '';
  document.getElementById("show_topic").value = '';
  var codeFile = editor.getValue();
  var json = {
    code: codeFile,
  };

  $.post("/compile", json, function(data, error, xhr) {

  });
});



function openFile(evt, fileName) {
    // Declare all variables
    var i, tabcontent, tablinks;

    // Get all elements with class="tabcontent" and hide them
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }

    // Get all elements with class="tablinks" and remove the class "active"
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab, and add an "active" class to the button that opened the tab
    document.getElementById(fileName).style.display = "block";
    evt.currentTarget.className += " active";
}

document.getElementById("defaultOpen").click();
</script>

  </body>

</html>

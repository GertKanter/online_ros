<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8"/>
  <link rel="stylesheet" type="text/css" href="styles.css" />
  <title>ROS, By working example</title>
  <meta name="description" content="This page has working ROS examples that you can edit, compile and run online." />
  <meta name="keywords" content="ROS, code, compile, example, tutorial" />
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.8/ace.js" type="text/javascript" charset="utf-8"></script>
</head>


  <body>

  <div class="navbar">
    <a href="index.html">ROS, by WORKING example</a>
    <a href="contribute.html">Contribute</a>
    <a href="about.html">About</a>
  </div>

<div style="float: left; width: 50%" class="main">

  <h1 id="example_title"></h1>
  <p id="description"></p>

  <select name="files" id="file_list" size="3" onchange="file_list_select();"></select>

  <div id="editor"></div>
      <input type="button" value="Compile" id="compile"> Run Command: <b id="run_cmd"></b>
</div>

<div style="float: right; width: 50%" class="feedback">
   <table>
     <tr>
      <td>Topics</td>
      <td>Services</td>
      <td>Nodes</td>
      <td>Params</td>
    </tr>
     <tr>
       <td><select name="topics" id="topic_list" size="5" onchange="topic_list_select();"></select></td>
       <td><select name="services" id="service_list" size="5" onchange="service_list_select();"></select></td>
       <td><select name="nodes" id="node_list" size="5" onchange="nodes_list_select();"></select></td>
       <td><select name="params" id="param_list" size="5" onchange="param_list_select();"></select></td>
    </tr>
   </table>
   <textarea id="show_compile" readonly="readonly"></textarea>
   <textarea id="show_topic" readonly="readonly"></textarea>

</div>


<script type='text/javascript'>

// ROS code
var ros = new ROSLIB.Ros();
var roslib_connected = false;
 function try_ros_connection() {
   if (roslib_connected == false)
   {
     ros.connect('ws://{{host_name}}:{{rosbridge_port}}');
   }
 }

 var interval_active = true;
 var interval = setInterval(try_ros_connection, 2000);


 ros.on('connection', function() {
   roslib_connected = true;
   console.log('Connected to websocket server.');
   interval_active = false;
   clearInterval(interval);
   var listener = new ROSLIB.Topic({
     ros : ros,
     name : '/chatter',
     messageType : 'std_msgs/String'
   });

   listener.subscribe(function(message) {
     console.log('Received message on ' + listener.name + ': ' + message.data);
     document.getElementById("show_topic").value += message.data + '\r';
     document.getElementById("show_topic").scrollTop = document.getElementById("show_topic").scrollHeight;
   });

   ros.getTopics(function(topics) {
     var sel = document.getElementById('topic_list');
     for (var topic in topics)
     {
       var opt = document.createElement('option');
       opt.innerHTML = topics[topic];
       opt.value = topics[topic];
       sel.appendChild(opt);
     }
   });
   ros.getNodes(function(nodes) {
     var sel = document.getElementById('node_list');
     for (var node in nodes)
     {
       var opt = document.createElement('option');
       opt.innerHTML = nodes[node];
       opt.value = nodes[node];
       sel.appendChild(opt);
     }
   });
   ros.getServices(function(services) {
     var sel = document.getElementById('service_list');
     for (var service in services)
     {
       var opt = document.createElement('option');
       opt.innerHTML = services[service];
       opt.value = services[service];
       sel.appendChild(opt);
     }
   });
   ros.getParams(function(params) {
     var sel = document.getElementById('param_list');
     for (var param in params)
     {
       var opt = document.createElement('option');
       opt.innerHTML = params[param];
       opt.value = params[param];
       sel.appendChild(opt);
     }
   });
 });

 ros.on('error', function(error) {
   console.log('Error connecting to websocket server: ', error);
 });

 ros.on('close', function() {
   console.log('Connection to websocket server closed.');
   roslib_connected = false;
   if (!interval_active)
   {
      interval_active = true;
      interval = setInterval(try_ros_connection, 1000);
   }
 });


$(document).ready(function(){
      var socket = io();
      socket.on('compile_output',function(msg){
      //  $("#show_compile").append(msg + '<br />');
      document.getElementById("show_compile").value += msg;
      document.getElementById("show_compile").scrollTop = document.getElementById("show_compile").scrollHeight
      });
});

var example_info;

var files = {};
var editor = ace.edit("editor");
editor.setTheme("ace/theme/chrome");
var EditSession = ace.require("ace/edit_session").EditSession;
var editor_sessions = {};

var example_name = location.search.split('name=')[1];

$.get("/get_files?name=" + example_name, function (data) {

  // parse the data into the files for the editor and the general example information
   var parsed_data = JSON.parse(data);
   files = parsed_data[0];
   example_info = parsed_data[1];

   // load each file into its own editor
   var sel = document.getElementById('file_list');
   for (var filename in files)
   {
     var opt = document.createElement('option');
     opt.value = filename;
     opt.innerHTML = filename;
     sel.appendChild(opt);
     var filename_extension = filename.split('.').pop();
     editor_sessions[filename] = new EditSession(filename);
     if (filename_extension == 'cpp' || filename_extension == 'c')
          editor_sessions[filename].setMode("ace/mode/c_cpp");
     else if (filename_extension == 'xml')
          editor_sessions[filename].setMode("ace/mode/xml");
     else
          editor_sessions[filename].setMode("ace/mode/text");
     editor_sessions[filename].setValue(files[filename], -1);
   }

   // set the initial file for editing
   // TODO: Test if this is set / valid
   editor.setSession(editor_sessions[example_info.example.start_file]);

   // set other parts of the page
   document.getElementById("run_cmd").innerHTML = example_info.example.run_cmd;
   document.getElementById("example_title").innerHTML = example_info.example.title;
   document.getElementById("description").innerHTML = example_info.example.description;
});

function file_list_select() {
  var sel = document.getElementById("file_list");
  var sel_val = sel.options[sel.selectedIndex].value;
  editor.setSession(editor_sessions[sel_val]);
  if (sel_val == 'CMakeLists.txt' || sel_val == 'package.xml')
  {
    editor.setReadOnly(true);
  } else {
    editor.setReadOnly(false);
  }
}


$('#compile').on('click', function() {
  document.getElementById("show_compile").value = '';
  document.getElementById("show_topic").value = '';

  var code = {};
  for (var filename in editor_sessions)
  {
    code[filename] = editor_sessions[filename].getValue();
  }

  var json = {
    code_files: code,
  };

  $.post("/compile?name=" + example_name, json, function(data, error, xhr) {

  });
});


</script>

<footer style="position: fixed; bottom: 0px; width: 100%; height: 40px; background-color: white;">
  Except where otherwise noted, these web pages are licensed under Creative Commons Attribution 3.0.
</footer>
  </body>

</html>
